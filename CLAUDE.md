# CLAUDE.md — AI 開發規範

本文件定義 AI 協助開發此專案時的完整工作流程與規範。

---

## 開發流程

每次收到新需求，嚴格遵守以下流程：

```
需求 → 開分支 → 規劃 → 開發 → 自動測試 → Code Review → 使用者 Review → Merge
```

### 1. 開分支

- 每個需求必須從 `main` 開一條新分支
- 分支命名：`feat/<功能簡述>`、`fix/<修復簡述>`、`refactor/<重構簡述>`
- 禁止直接在 `main` 上開發

### 2. 規劃需求

- 先分析需求，列出具體的實作項目（用 TodoWrite 追蹤）
- 需要釐清的地方主動向使用者提問，不要猜測
- 規劃時考慮對現有架構的影響

### 3. 開發

程式碼必須符合三個原則：

- **維護性**：邏輯清晰、職責單一、錯誤處理完整
- **擴充性**：使用插件式架構、抽象基底類別，新功能不應修改既有模組
- **可讀性**：命名語意化、結構一致、遵循專案既有風格

架構規範：

- 新模組繼承 `BaseModule`，放在 `whitehats/modules/`
- 新掃描器繼承 `BaseScanner`，放在 `whitehats/scanner/`
- 新報告器繼承 `BaseReporter`，放在 `whitehats/reporter/`
- Payload 檔案放在 `whitehats/payloads/`
- 單元測試放在 `tests/`，命名 `test_<模組名>.py`
- 新模組必須註冊到對應的 `__init__.py`
- 設定項必須加到 `config/default_config.yaml`

### 4. 實作測試

開發完成後，AI 必須自行撰寫並執行測試：

- **主動提供測試規劃**：說明要測哪些項目、幾個測試案例、需要什麼資訊
- **使用 pytest**：所有測試用 `pytest tests/ -v` 執行
- **自動重試**：測試失敗時，AI 必須自行分析錯誤、修正、重新執行，最少重試 3 次
- **重試仍失敗**：3 次後仍無法通過，才向使用者回報問題並請求協助
- **覆蓋範圍**：每個新功能至少包含正向測試、邊界測試、錯誤處理測試

### 5. Code Review（AI 自審）

測試全部通過後，AI 自行審查：

- 有無安全漏洞（注入、XSS、路徑遍歷等）
- 有無破壞既有功能
- 命名與風格是否一致
- 是否有不必要的複雜度
- 測試覆蓋是否足夠

### 6. 使用者 Review

AI 完成自審後，向使用者報告：

- 本次變更摘要（改了什麼、為什麼）
- 測試結果（幾項通過 / 失敗）
- 請使用者 Review

### 7. 結果處理

- **使用者同意** → Merge 到 `main`，推送
- **使用者不同意** → 根據回饋繼續修改 → 重新跑測試 → 重新 Code Review → 再次請使用者 Review（重複直到同意）

---

## 流程圖

```
         ┌─────────┐
         │  新需求  │
         └────┬────┘
              ▼
         開新分支 (feat/xxx)
              │
              ▼
         規劃需求 + TodoWrite
              │
              ▼
      ┌───── 開發 ─────┐
      │   維護性        │
      │   擴充性        │
      │   可讀性        │
      └───────┬────────┘
              │
              ▼
    ┌─── 撰寫 + 執行測試 ───┐
    │  pytest tests/ -v      │
    │  失敗 → 自動重試 ×3   │
    └───────┬────────────────┘
            │
            ▼
      AI Code Review
            │
            ▼
      請使用者 Review
            │
       ┌────┴────┐
       ▼         ▼
     同意      不同意
       │         │
       ▼         └──→ 繼續修改 → 測試 → Review（循環）
  Merge to main
```

---

## 程式碼風格

- Python 3.9+
- 型別標註（type hints）
- 使用 `logging` 模組，不用 `print` 除錯
- Dataclass 用於資料模型
- 抽象基底類別（ABC）用於可擴充介面
- 測試用 `unittest.mock` 隔離外部依賴

## Commit 訊息格式

```
<type>: <簡短描述>

類型：feat / fix / refactor / test / docs
```

範例：
```
feat: 新增 SSRF 偵測模組
fix: 修正 SQL 注入偵測的誤判
test: 補充 ConcurrentScanner 測試
docs: 更新 README 使用說明
```
